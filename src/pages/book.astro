---
// Enable server-side rendering for this page only
export const prerender = false;

import Hero from '@/components/Hero.astro';
import Icon from '@/components/Icon.astro';
import Layout from '@/components/Layout.astro';
import LocationBookingSection from '@/components/LocationBookingSection.astro';
import { getActiveLocations } from '@/config/locations.ts';

const activeLocations = getActiveLocations();

// Fetch actual event types from Cal.com API (server-side with Vercel)
let availableEventTypes: any[] = [];
try {
  const apiKey = import.meta.env.CAL_API_KEY;
  if (apiKey) {
    console.log('Fetching Cal.com event types...');
    const response = await fetch(
      `https://api.cal.com/v1/event-types?apiKey=${apiKey}`,
      {
        headers: {
          'Content-Type': 'application/json',
        },
      },
    );
    if (response.ok) {
      const data = await response.json();
      availableEventTypes = data.event_types || [];
      console.log(`Found ${availableEventTypes.length} event types`);
    } else {
      console.warn(
        'Cal.com API response not ok:',
        response.status,
        response.statusText,
      );
    }
  } else {
    console.warn('CAL_API_KEY environment variable not found');
  }
} catch (error) {
  console.warn('Could not fetch event types for booking page:', error);
}

// Use Cal.com data if available, otherwise fallback
const eventTypesToUse =
  availableEventTypes.length > 0
    ? availableEventTypes.map((et) => ({
        title: et.title,
        slug: et.slug,
        isRental: et.title.toLowerCase().includes('rental'),
      }))
    : [];

// Group event types by location and type
const tourEventsByLocation = new Map();
const rentalEventsByLocation = new Map();

eventTypesToUse.forEach((eventType) => {
  // Parse location from title (format: "Location - Event Name")
  const titleParts = eventType.title.split(' - ');
  if (titleParts.length >= 2) {
    const location = titleParts[0];
    const eventName = titleParts.slice(1).join(' - ');

    // Use the isRental flag to determine type
    const targetMap = eventType.isRental
      ? rentalEventsByLocation
      : tourEventsByLocation;

    if (!targetMap.has(location)) {
      targetMap.set(location, []);
    }

    targetMap.get(location).push({
      name: eventName,
      calLink: `paddlesports/${eventType.slug}`,
      type:
        eventName.toLowerCase().includes('2-hour') ||
        eventName.toLowerCase().includes('full')
          ? 'primary'
          : 'secondary',
    });
  }
});

// Generate location data for tours
const tourLocations = activeLocations
  .map((location) => {
    const events = tourEventsByLocation.get(location.name) || [];
    return {
      location: {
        name: location.name,
        slug: location.slug,
      },
      eventTypes: events,
    };
  })
  .filter((loc) => loc.eventTypes.length > 0);

// Generate location data for rentals
const rentalLocations = activeLocations
  .map((location) => {
    const events = rentalEventsByLocation.get(location.name) || [];
    return {
      location: {
        name: location.name,
        slug: location.slug,
      },
      eventTypes: events,
    };
  })
  .filter((loc) => loc.eventTypes.length > 0);

// Breadcrumbs for SEO
// const breadcrumbs = [
//   { name: 'Home', url: '/' },
//   { name: 'Book Your Adventure', url: '/book' },
// ];
---

<Layout
  title="Book Your Adventure - AnyBody Paddlesports"
  description="Book paddle board tours and equipment rentals with AnyBody Paddlesports. Choose from guided tours or equipment-only rentals."
  keywords="book paddle board tour, paddleboard rental booking, SUP tour reservation, paddle board lessons booking, California water sports booking"
  schemaType="Service">
  <!-- Hero Section -->
  <Hero
    title="Book Your Adventure"
    description="Choose from guided tours with certified instructors or equipment rentals for your own adventure"
  />

  <section class="section-padding bg-gray-50">
    <div class="container-custom">
      <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        <!-- Guided Tours -->
        <article class="bg-white rounded-xl shadow-lg p-8">
          <div class="text-center mb-6">
            <div
              class="w-16 h-16 bg-primary-600 rounded-full flex items-center justify-center mx-auto mb-4"
              aria-hidden="true">
              <Icon name="users" size="lg" class="text-white" />
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Guided Tours</h2>
            <p class="text-gray-600">
              Professional instruction and guided experiences
            </p>
          </div>

          <ul class="space-y-3 mb-8" role="list">
            <li class="flex items-center text-gray-700">
              <Icon name="check-solid" size="sm" class="text-green-500 mr-3" />
              Certified instructor included
            </li>
            <li class="flex items-center text-gray-700">
              <Icon name="check-solid" size="sm" class="text-green-500 mr-3" />
              All equipment provided
            </li>
            <li class="flex items-center text-gray-700">
              <Icon name="check-solid" size="sm" class="text-green-500 mr-3" />
              Safety training included
            </li>
            <li class="flex items-center text-gray-700">
              <Icon name="check-solid" size="sm" class="text-green-500 mr-3" />
              Custom video option available
            </li>
          </ul>

          <!-- Location-based booking options -->
          <div class="space-y-4">
            {
              tourLocations.length > 0 ? (
                tourLocations.map((locationData) => (
                  <LocationBookingSection
                    location={locationData.location}
                    eventTypes={locationData.eventTypes}
                  />
                ))
              ) : (
                <div class="border-2 border-yellow-200 rounded-lg p-6 bg-yellow-50">
                  <h4 class="font-semibold text-yellow-800 mb-2">
                    üöß Tours Coming Soon!
                  </h4>
                  <p class="text-yellow-700 text-sm mb-3">
                    We're setting up our guided tour bookings. Check back soon
                    or contact us directly to arrange a tour.
                  </p>
                  <a href="/contact" class="btn-secondary text-sm">
                    Contact Us
                  </a>
                </div>
              )
            }
          </div>
        </article>

        <!-- Equipment Rentals -->
        <article class="bg-white rounded-xl shadow-lg p-8">
          <div class="text-center mb-6">
            <div
              class="w-16 h-16 bg-accent-600 rounded-full flex items-center justify-center mx-auto mb-4"
              aria-hidden="true">
              <Icon name="cube" size="lg" class="text-white" />
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">
              Equipment Rentals
            </h2>
            <p class="text-gray-600">
              Rent quality gear for your own adventure
            </p>
          </div>

          <ul class="space-y-3 mb-8" role="list">
            <li class="flex items-center text-gray-700">
              <Icon name="check-solid" size="sm" class="text-green-500 mr-3" />
              Premium paddle boards
            </li>
            <li class="flex items-center text-gray-700">
              <Icon name="check-solid" size="sm" class="text-green-500 mr-3" />
              Dry bags included
            </li>
            <li class="flex items-center text-gray-700">
              <Icon name="check-solid" size="sm" class="text-green-500 mr-3" />
              Flexible pickup/return
            </li>
          </ul>

          <!-- Location-based rental options -->
          <div class="space-y-4">
            {
              rentalLocations.length > 0 ? (
                rentalLocations.map((locationData) => (
                  <LocationBookingSection
                    location={locationData.location}
                    eventTypes={locationData.eventTypes}
                  />
                ))
              ) : (
                <div class="border-2 border-yellow-200 rounded-lg p-6 bg-yellow-50">
                  <h4 class="font-semibold text-yellow-800 mb-2">
                    üöß Rentals Coming Soon!
                  </h4>
                  <p class="text-yellow-700 text-sm mb-3">
                    We're setting up our equipment rental bookings. Check back
                    soon or contact us directly to arrange a rental.
                  </p>
                  <a href="/contact" class="btn-secondary text-sm">
                    Contact Us
                  </a>
                </div>
              )
            }
          </div>
        </article>
      </div>

      <div class="text-center mt-12">
        <p class="text-gray-600 mb-4">
          Have questions about booking? Need a custom package?
        </p>
        <a href="/contact" class="btn-secondary"> Contact Us </a>
      </div>
    </div>
  </section>

  <!-- Cal.com embed script with optimized loading -->
  <script>
    // Optimized Cal.com loading - only load when user interacts with booking buttons
    let calScriptLoaded = false;
    let calScriptLoading = false;
    let calAvailable = false;

    // Check if we're in development or if we should skip embed
    const isDevelopment =
      window.location.hostname === 'localhost' ||
      window.location.hostname === '127.0.0.1';
    const skipEmbed =
      isDevelopment || localStorage.getItem('cal-embed-disabled') === 'true';

    function waitForCal(
      maxAttempts = 10,
      attemptInterval = 300,
    ): Promise<void> {
      return new Promise<void>((resolve, reject) => {
        let attempts = 0;

        const checkCal = () => {
          attempts++;

          // Check if Cal exists and has the required methods
          if (
            typeof (window as any).Cal !== 'undefined' &&
            typeof (window as any).Cal === 'function'
          ) {
            try {
              // Test if Cal actually works by checking its methods
              if (
                (window as any).Cal.ns &&
                typeof (window as any).Cal.ns === 'object'
              ) {
                console.log('Cal.com API ready and functional');
                calAvailable = true;
                window.dispatchEvent(new CustomEvent('cal-ready'));
                resolve();
                return;
              }
            } catch (testError) {
              console.warn(
                'Cal object exists but is not functional:',
                testError,
              );
            }
          }

          if (attempts >= maxAttempts) {
            const error = new Error(
              `Cal.com API not available after ${maxAttempts} attempts (${maxAttempts * attemptInterval}ms)`,
            );
            console.warn(error.message);
            if (isDevelopment) {
              console.info(
                "üí° Tip: Cal.com embeds often don't work in development. This is normal and will work in production.",
              );
            }
            calAvailable = false;
            window.dispatchEvent(new CustomEvent('cal-error'));
            reject(error);
          } else {
            setTimeout(checkCal, attemptInterval);
          }
        };

        checkCal();
      });
    }

    function loadCalScript(): Promise<void> {
      // Skip embed loading if disabled or in development
      if (skipEmbed) {
        console.log(
          'Cal.com embed disabled (development mode or manual override)',
        );
        window.dispatchEvent(new CustomEvent('cal-error'));
        return Promise.reject(new Error('Cal.com embed disabled'));
      }

      if (calAvailable) {
        // If Cal is already available and working, return immediately
        return Promise.resolve();
      }

      if (calScriptLoaded) {
        // If script is loaded but Cal isn't available, wait for it
        return waitForCal();
      }

      if (calScriptLoading) {
        // If currently loading, wait for it to complete
        return new Promise<void>((resolve, reject) => {
          const checkLoading = () => {
            if (calAvailable) {
              resolve();
            } else if (calScriptLoaded) {
              waitForCal().then(resolve).catch(reject);
            } else if (!calScriptLoading) {
              reject(new Error('Cal.com script loading failed'));
            } else {
              setTimeout(checkLoading, 100);
            }
          };
          checkLoading();
        });
      }

      calScriptLoading = true;

      return new Promise<void>((resolve, reject) => {
        // Add error listener for script errors
        const originalOnError = window.onerror;
        let scriptErrorOccurred = false;

        window.onerror = function (message, source, lineno, colno, error) {
          if (source && source.includes('cal.com/embed/embed.js')) {
            console.warn('Cal.com script error detected:', message);
            scriptErrorOccurred = true;
          }
          if (originalOnError) {
            return originalOnError(message, source, lineno, colno, error);
          }
          return false;
        };

        const script = document.createElement('script');
        script.src = 'https://app.cal.com/embed/embed.js';
        script.async = true;

        script.onload = function () {
          calScriptLoaded = true;
          calScriptLoading = false;
          console.log('Cal.com embed script loaded');

          // Restore original error handler
          window.onerror = originalOnError;

          // Check if there were script errors
          if (scriptErrorOccurred) {
            console.warn('Cal.com script loaded but had internal errors');
            calAvailable = false;
            window.dispatchEvent(new CustomEvent('cal-error'));
            reject(new Error('Cal.com script had internal errors'));
            return;
          }

          // Wait for Cal API to be available with better error handling
          waitForCal()
            .then(resolve)
            .catch((error) => {
              console.warn('Cal.com API failed to initialize:', error);
              reject(error);
            });
        };

        script.onerror = function () {
          calScriptLoading = false;
          window.onerror = originalOnError;
          const error = new Error('Failed to load Cal.com embed script');
          console.warn(error.message);
          window.dispatchEvent(new CustomEvent('cal-error'));
          reject(error);
        };

        // Set a timeout for the entire loading process (reduced to 5 seconds)
        setTimeout(() => {
          if (!calAvailable && calScriptLoading) {
            console.warn('Cal.com script loading timeout');
            calScriptLoading = false;
            window.onerror = originalOnError;
            window.dispatchEvent(new CustomEvent('cal-error'));
            reject(new Error('Cal.com script loading timeout'));
          }
        }, 5000); // 5 second timeout

        document.head.appendChild(script);
      });
    }

    // Load Cal.com script on first user interaction with booking buttons
    document.addEventListener('DOMContentLoaded', function () {
      const bookingButtons = document.querySelectorAll(
        '.cal-booking-btn, [href="/book"]',
      );

      // Add development notice if in development mode
      if (isDevelopment) {
        console.info(
          'üöÄ Development Mode: Cal.com embeds will use fallback links. This is normal and will work in production.',
        );
      }

      // Use intersection observer to preload when booking section is visible
      if ('IntersectionObserver' in window && !skipEmbed) {
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                console.log('Booking section visible, preloading Cal.com...');
                loadCalScript().catch((error) => {
                  console.warn('Failed to preload Cal.com script:', error);
                });
                observer.disconnect();
              }
            });
          },
          { rootMargin: '50px' },
        );

        bookingButtons.forEach((btn) => observer.observe(btn));
      }

      // Fallback: load on first interaction (only if not skipped)
      bookingButtons.forEach((btn) => {
        const loadOnInteraction = () => {
          if (!skipEmbed) {
            console.log('User interaction detected, loading Cal.com...');
            loadCalScript().catch((error) => {
              console.warn(
                'Failed to load Cal.com script on interaction:',
                error,
              );
            });
          }
        };

        btn.addEventListener('mouseenter', loadOnInteraction, { once: true });
        btn.addEventListener('focus', loadOnInteraction, { once: true });
        btn.addEventListener('click', loadOnInteraction, { once: true });
      });
    });

    // Add developer controls to localStorage
    if (isDevelopment) {
      // Expose helper functions for development
      (window as any).calDebug = {
        enableEmbed: () => {
          localStorage.removeItem('cal-embed-disabled');
          console.log('Cal.com embed enabled - reload page to take effect');
        },
        disableEmbed: () => {
          localStorage.setItem('cal-embed-disabled', 'true');
          console.log('Cal.com embed disabled - reload page to take effect');
        },
        status: () => {
          console.log('Cal.com embed status:', {
            isDevelopment,
            skipEmbed,
            calAvailable,
            calScriptLoaded,
            calScriptLoading,
          });
        },
      };
      console.log(
        'üõ†Ô∏è  Development tools available: window.calDebug.enableEmbed(), window.calDebug.disableEmbed(), window.calDebug.status()',
      );
    }
  </script>
</Layout>
